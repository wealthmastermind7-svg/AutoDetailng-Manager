<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Appointment</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --black: #000000;
      --charcoal: #1a1a1a;
      --graphite: #2d2d2d;
      --smoke: #4a4a4a;
      --silver: #8a8a8a;
      --pearl: #f5f5f5;
      --white: #ffffff;
      --accent: #000000;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--pearl);
      color: var(--black);
      min-height: 100vh;
    }
    
    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 24px;
      min-height: 100vh;
    }
    
    .header {
      text-align: center;
      margin-bottom: 32px;
      padding-top: 24px;
    }
    
    .header h1 {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -1px;
      margin-bottom: 8px;
    }
    
    .header p {
      color: var(--smoke);
      font-size: 16px;
    }
    
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
    }
    
    .step-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--silver);
      transition: all 0.3s ease;
    }
    
    .step-dot.active {
      background: var(--black);
      width: 24px;
      border-radius: 4px;
    }
    
    .screen {
      display: none;
      animation: fadeIn 0.4s ease;
    }
    
    .screen.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .section-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    .service-card {
      background: var(--white);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .service-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    
    .service-card.selected {
      border-color: var(--black);
    }
    
    .service-card h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .service-card .meta {
      display: flex;
      justify-content: space-between;
      color: var(--smoke);
      font-size: 14px;
    }
    
    .service-card .price {
      font-size: 20px;
      font-weight: 700;
      color: var(--black);
    }
    
    .service-card .description {
      color: var(--smoke);
      font-size: 14px;
      margin-top: 8px;
    }
    
    .date-picker {
      background: var(--white);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .date-picker input {
      width: 100%;
      padding: 16px;
      border: 2px solid var(--pearl);
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s ease;
    }
    
    .date-picker input:focus {
      border-color: var(--black);
    }
    
    .time-slots {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    
    .time-slot {
      background: var(--white);
      border: 2px solid var(--pearl);
      border-radius: 12px;
      padding: 14px 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
    }
    
    .time-slot:hover:not(.unavailable) {
      border-color: var(--black);
    }
    
    .time-slot.selected {
      background: var(--black);
      color: var(--white);
      border-color: var(--black);
    }
    
    .time-slot.unavailable {
      background: var(--pearl);
      color: var(--silver);
      cursor: not-allowed;
      text-decoration: line-through;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--smoke);
    }
    
    .form-group input {
      width: 100%;
      padding: 16px;
      border: 2px solid var(--pearl);
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      background: var(--white);
      transition: border-color 0.3s ease;
    }
    
    .form-group input:focus {
      border-color: var(--black);
    }
    
    .summary-card {
      background: var(--white);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--pearl);
    }
    
    .summary-row:last-child {
      border-bottom: none;
      font-weight: 700;
      font-size: 18px;
      padding-top: 16px;
    }
    
    .summary-row .label {
      color: var(--smoke);
    }
    
    .btn {
      width: 100%;
      padding: 18px;
      border: none;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--black);
      color: var(--white);
    }
    
    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .btn-primary:disabled {
      background: var(--silver);
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: transparent;
      border: 2px solid var(--pearl);
      color: var(--black);
      margin-bottom: 12px;
    }
    
    .btn-secondary:hover {
      border-color: var(--black);
    }
    
    .confirmation-icon {
      width: 80px;
      height: 80px;
      background: var(--black);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }
    
    .confirmation-icon svg {
      width: 40px;
      height: 40px;
      stroke: var(--white);
    }
    
    .confirmation-text {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .confirmation-text h2 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .confirmation-text p {
      color: var(--smoke);
      font-size: 16px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--smoke);
    }
    
    .error {
      background: #fee;
      color: #c00;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .not-found {
      text-align: center;
      padding: 60px 20px;
    }
    
    .not-found h2 {
      font-size: 24px;
      margin-bottom: 12px;
    }
    
    .not-found p {
      color: var(--smoke);
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loading" class="loading">
      <p>Loading...</p>
    </div>
    
    <div id="not-found" class="not-found" style="display: none;">
      <h2>Business Not Found</h2>
      <p>The booking page you're looking for doesn't exist.</p>
    </div>
    
    <div id="app" style="display: none;">
      <div class="header">
        <h1 id="business-name">Business Name</h1>
        <p id="business-tagline">Book your appointment</p>
      </div>
      
      <div class="step-indicator">
        <div class="step-dot active" data-step="1"></div>
        <div class="step-dot" data-step="2"></div>
        <div class="step-dot" data-step="3"></div>
        <div class="step-dot" data-step="4"></div>
      </div>
      
      <!-- Screen 1: Service Selection -->
      <div id="screen-1" class="screen active">
        <h2 class="section-title">Choose a Service</h2>
        <div id="services-list"></div>
        <button class="btn btn-primary" id="btn-to-time" disabled>Continue</button>
      </div>
      
      <!-- Screen 2: Time Selection -->
      <div id="screen-2" class="screen">
        <h2 class="section-title">Select Date & Time</h2>
        <div class="date-picker">
          <input type="date" id="date-input" min="">
        </div>
        <div id="slots-container" style="display: none;">
          <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--smoke);">Available Times</h3>
          <div class="time-slots" id="time-slots"></div>
        </div>
        <div style="margin-top: 24px;">
          <button class="btn btn-secondary" id="btn-back-1">Back</button>
          <button class="btn btn-primary" id="btn-to-checkout" disabled>Continue</button>
        </div>
      </div>
      
      <!-- Screen 3: Checkout -->
      <div id="screen-3" class="screen">
        <h2 class="section-title">Your Details</h2>
        <div id="checkout-error" class="error" style="display: none;"></div>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="customer-name" placeholder="John Smith">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="customer-email" placeholder="john@example.com">
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="customer-phone" placeholder="(555) 123-4567">
        </div>
        
        <div class="summary-card">
          <h3 style="font-size: 16px; margin-bottom: 16px;">Booking Summary</h3>
          <div class="summary-row">
            <span class="label">Service</span>
            <span id="summary-service">-</span>
          </div>
          <div class="summary-row">
            <span class="label">Date</span>
            <span id="summary-date">-</span>
          </div>
          <div class="summary-row">
            <span class="label">Time</span>
            <span id="summary-time">-</span>
          </div>
          <div class="summary-row">
            <span class="label">Total</span>
            <span id="summary-total">$0.00</span>
          </div>
        </div>
        
        <button class="btn btn-secondary" id="btn-back-2">Back</button>
        <button class="btn btn-primary" id="btn-confirm">Confirm Booking</button>
      </div>
      
      <!-- Screen 4: Confirmation -->
      <div id="screen-4" class="screen">
        <div class="confirmation-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <div class="confirmation-text">
          <h2>Booking Confirmed!</h2>
          <p>We've sent a confirmation to your email.</p>
        </div>
        
        <div class="summary-card">
          <div class="summary-row">
            <span class="label">Confirmation #</span>
            <span id="confirm-id">-</span>
          </div>
          <div class="summary-row">
            <span class="label">Service</span>
            <span id="confirm-service">-</span>
          </div>
          <div class="summary-row">
            <span class="label">Date & Time</span>
            <span id="confirm-datetime">-</span>
          </div>
          <div class="summary-row">
            <span class="label">Total Paid</span>
            <span id="confirm-total">$0.00</span>
          </div>
        </div>
        
        <button class="btn btn-primary" id="btn-new-booking">Book Another Appointment</button>
      </div>
    </div>
  </div>
  
  <script>
    // State
    let business = null;
    let services = [];
    let selectedService = null;
    let selectedDate = null;
    let selectedTime = null;
    let currentStep = 1;
    
    // Get business slug from URL
    const pathParts = window.location.pathname.split('/');
    const businessSlug = pathParts[pathParts.indexOf('book') + 1];
    
    // Initialize
    async function init() {
      try {
        // Fetch business
        const res = await fetch(`/api/businesses/${businessSlug}`);
        if (!res.ok) {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('not-found').style.display = 'block';
          return;
        }
        
        business = await res.json();
        document.getElementById('business-name').textContent = business.name;
        
        // Fetch services
        const servicesRes = await fetch(`/api/businesses/${business.id}/services`);
        services = await servicesRes.json();
        
        renderServices();
        
        // Set min date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date-input').min = today;
        document.getElementById('date-input').value = today;
        
        // Show app
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        
        setupEventListeners();
      } catch (error) {
        console.error('Init error:', error);
        document.getElementById('loading').innerHTML = '<p>Error loading. Please refresh.</p>';
      }
    }
    
    function renderServices() {
      const container = document.getElementById('services-list');
      container.innerHTML = services.map(service => `
        <div class="service-card" data-id="${service.id}">
          <h3>${service.name}</h3>
          <div class="meta">
            <span>${service.duration} min</span>
            <span class="price">$${(service.price / 100).toFixed(2)}</span>
          </div>
          ${service.description ? `<p class="description">${service.description}</p>` : ''}
        </div>
      `).join('');
      
      // Add click handlers
      container.querySelectorAll('.service-card').forEach(card => {
        card.addEventListener('click', () => {
          container.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          selectedService = services.find(s => s.id === card.dataset.id);
          document.getElementById('btn-to-time').disabled = false;
        });
      });
    }
    
    async function loadTimeSlots() {
      if (!selectedDate || !business) return;
      
      const container = document.getElementById('time-slots');
      container.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">Loading...</p>';
      document.getElementById('slots-container').style.display = 'block';
      
      try {
        const res = await fetch(`/api/businesses/${business.id}/slots/${selectedDate}?serviceId=${selectedService.id}`);
        const data = await res.json();
        
        if (data.slots.length === 0) {
          container.innerHTML = `<p style="grid-column: 1/-1; text-align: center; color: var(--smoke);">${data.message || 'No slots available'}</p>`;
          return;
        }
        
        container.innerHTML = data.slots.map(slot => `
          <div class="time-slot ${slot.available ? '' : 'unavailable'}" data-time="${slot.time}" ${slot.available ? '' : 'disabled'}>
            ${slot.time}
          </div>
        `).join('');
        
        container.querySelectorAll('.time-slot:not(.unavailable)').forEach(slot => {
          slot.addEventListener('click', () => {
            container.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
            slot.classList.add('selected');
            selectedTime = slot.dataset.time;
            document.getElementById('btn-to-checkout').disabled = false;
          });
        });
      } catch (error) {
        container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #c00;">Error loading slots</p>';
      }
    }
    
    function goToStep(step) {
      currentStep = step;
      
      // Update step indicators
      document.querySelectorAll('.step-dot').forEach((dot, i) => {
        dot.classList.toggle('active', i + 1 === step);
      });
      
      // Show correct screen
      document.querySelectorAll('.screen').forEach((screen, i) => {
        screen.classList.toggle('active', i + 1 === step);
      });
      
      // Update summary on checkout
      if (step === 3) {
        document.getElementById('summary-service').textContent = selectedService.name;
        document.getElementById('summary-date').textContent = new Date(selectedDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('summary-time').textContent = selectedTime;
        document.getElementById('summary-total').textContent = `$${(selectedService.price / 100).toFixed(2)}`;
      }
    }
    
    async function confirmBooking() {
      const name = document.getElementById('customer-name').value.trim();
      const email = document.getElementById('customer-email').value.trim();
      const phone = document.getElementById('customer-phone').value.trim();
      
      const errorEl = document.getElementById('checkout-error');
      
      if (!name || !email) {
        errorEl.textContent = 'Please fill in your name and email.';
        errorEl.style.display = 'block';
        return;
      }
      
      errorEl.style.display = 'none';
      
      try {
        // Create or get customer
        const customerRes = await fetch(`/api/businesses/${business.id}/customers`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, phone })
        });
        const customer = await customerRes.json();
        
        // Create booking
        const bookingRes = await fetch(`/api/businesses/${business.id}/bookings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customerId: customer.id,
            serviceId: selectedService.id,
            date: selectedDate,
            time: selectedTime,
            status: 'confirmed',
            totalPrice: selectedService.price
          })
        });
        
        const booking = await bookingRes.json();
        
        // Show confirmation
        document.getElementById('confirm-id').textContent = booking.id.substring(0, 8).toUpperCase();
        document.getElementById('confirm-service').textContent = selectedService.name;
        document.getElementById('confirm-datetime').textContent = `${new Date(selectedDate).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })} at ${selectedTime}`;
        document.getElementById('confirm-total').textContent = `$${(selectedService.price / 100).toFixed(2)}`;
        
        goToStep(4);
      } catch (error) {
        console.error('Booking error:', error);
        errorEl.textContent = 'Failed to create booking. Please try again.';
        errorEl.style.display = 'block';
      }
    }
    
    function setupEventListeners() {
      document.getElementById('btn-to-time').addEventListener('click', () => {
        goToStep(2);
        loadTimeSlots();
      });
      
      document.getElementById('date-input').addEventListener('change', (e) => {
        selectedDate = e.target.value;
        selectedTime = null;
        document.getElementById('btn-to-checkout').disabled = true;
        loadTimeSlots();
      });
      
      document.getElementById('btn-back-1').addEventListener('click', () => goToStep(1));
      document.getElementById('btn-to-checkout').addEventListener('click', () => goToStep(3));
      document.getElementById('btn-back-2').addEventListener('click', () => goToStep(2));
      document.getElementById('btn-confirm').addEventListener('click', confirmBooking);
      
      document.getElementById('btn-new-booking').addEventListener('click', () => {
        selectedService = null;
        selectedDate = null;
        selectedTime = null;
        document.getElementById('customer-name').value = '';
        document.getElementById('customer-email').value = '';
        document.getElementById('customer-phone').value = '';
        document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
        document.getElementById('btn-to-time').disabled = true;
        document.getElementById('btn-to-checkout').disabled = true;
        goToStep(1);
      });
      
      // Set initial date
      selectedDate = document.getElementById('date-input').value;
    }
    
    // Start
    init();
  </script>
</body>
</html>
